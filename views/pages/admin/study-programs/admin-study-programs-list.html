{{define "content"}}
<div x-data="prodiSync()" class="space-y-6">

    <div>
        <a href="/admin/dashboard" class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition text-sm font-medium">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            Kembali ke Dashboard Admin
        </a>
    </div>
    
    <div class="flex justify-between items-center border-b border-gray-200 pb-4">
        <div>
            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <div class="p-2 bg-green-50 rounded-lg">
                    <i data-lucide="graduation-cap" class="w-5 h-5 text-green-600"></i>
                </div>
                Data Program Studi
            </h3>
            <p class="text-gray-500 text-sm mt-1 ml-1">Daftar program studi & jurusan induknya.</p>
        </div>

        <button 
            @click="startSync()" 
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition shadow-sm hover:shadow active:scale-95 transform"
        >
            <i data-lucide="refresh-cw" class="w-4 h-4"></i> 
            Sync Prodi
        </button>
    </div>

    <div class="bg-white shadow-sm rounded-xl overflow-hidden border border-gray-200">
        <table class="w-full text-sm text-left">
            <thead class="bg-gray-50 text-gray-700 border-b">
                <tr>
                    <th class="px-6 py-3 w-20 font-semibold uppercase text-xs tracking-wider">ID</th>
                    <th class="px-6 py-3 font-semibold uppercase text-xs tracking-wider">Nama Program Studi</th>
                    <th class="px-6 py-3 font-semibold uppercase text-xs tracking-wider">Jurusan Induk</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {{range .Data.Data}}
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 text-gray-500 font-mono text-xs">#{{.ID}}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">{{.Name}}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                            {{.MajorName}}
                        </span>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="3" class="px-6 py-12 text-center text-gray-400 flex flex-col items-center gap-2">
                        <i data-lucide="folder-open" class="w-8 h-8 text-gray-300"></i>
                        <span>Belum ada data prodi. Silakan tekan tombol Sync.</span>
                        <p class="text-xs text-orange-500 mt-1">*Pastikan Jurusan sudah di-sync terlebih dahulu.</p>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    <div x-show="showSync" x-cloak class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center p-4 z-50"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
         
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl border border-gray-100 overflow-hidden">
            
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                    <span x-show="!syncCompleted" class="text-green-600 animate-spin">
                        <i data-lucide="loader-2" class="w-5 h-5"></i>
                    </span>
                    <span x-show="syncCompleted" class="text-green-600">
                        <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                    </span>
                    
                    <span x-text="syncCompleted ? 'Sinkronisasi Selesai' : 'Sedang Sinkronisasi...'"></span>
                </h3>
            </div>

            <div class="p-6 space-y-6">
                <div>
                    <div class="flex justify-between text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">
                        <span>Status</span>
                        <span x-text="syncProgress + '%'"></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 h-3 rounded-full transition-all duration-300 ease-out"
                             :style="`width: ${syncProgress}%`">
                             <div class="w-full h-full opacity-30 bg-white animate-pulse"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-lg p-4 font-mono text-xs h-48 overflow-y-auto border border-slate-700 shadow-inner custom-scrollbar ring-1 ring-white/10">
                    <template x-for="log in syncLogs">
                        <div class="mb-1.5 flex items-start gap-2">
                            <span class="text-green-400 shrink-0 mt-0.5">➜</span>
                            <span class="text-slate-300 leading-relaxed" x-text="log"></span>
                        </div>
                    </template>
                    <span x-show="!syncCompleted" class="inline-block w-2 h-4 bg-slate-500 animate-pulse align-middle ml-1"></span>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 border-t flex justify-end">
                <button x-show="syncCompleted" @click="finishSync()" 
                    class="bg-gray-900 hover:bg-black text-white px-6 py-2 rounded-lg font-medium transition shadow-lg flex items-center gap-2 transform hover:-translate-y-0.5">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Tutup & Refresh
                </button>
                <span x-show="!syncCompleted" class="text-xs text-gray-400 italic mt-2 flex items-center gap-1">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i>
                    Mohon jangan tutup halaman ini...
                </span>
            </div>
        </div>
    </div>

</div>

<script>
    // PENTING: Gunakan window agar scope global
    window.prodiSync = function() {
        return {
            showSync: false,
            syncProgress: 0,
            syncCompleted: false,
            syncLogs: [],

            startSync() {
                this.showSync = true;
                this.syncProgress = 0;
                this.syncCompleted = false;
                this.syncLogs = ['Menginisialisasi koneksi...'];

                // URL Endpoint SSE
                const eventSource = new EventSource('/admin/prodi/sync/stream');

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Update Data UI
                        if (data.log) this.syncLogs.push(data.log);
                        if (data.progress) this.syncProgress = data.progress;

                        // Auto Scroll
                        this.$nextTick(() => {
                            const terminal = document.querySelector('.custom-scrollbar');
                            if(terminal) terminal.scrollTop = terminal.scrollHeight;
                        });

                        // Handle Status
                        if (data.status === 'done') {
                            this.syncCompleted = true;
                            this.syncLogs.push('✨ Proses Selesai!');
                            eventSource.close();
                        }
                        if (data.status === 'error') {
                            this.syncLogs.push('❌ ERROR: ' + data.message);
                            this.syncCompleted = true;
                            eventSource.close();
                        }
                    } catch (e) {
                        console.error("Error parsing SSE:", e);
                    }
                };

                eventSource.onerror = () => {
                    if(!this.syncCompleted) {
                        this.syncLogs.push('⚠️ Koneksi terputus. Cek logs server.');
                        this.syncCompleted = true;
                    }
                    eventSource.close();
                };
            },

            finishSync() {
                this.showSync = false;
                window.location.reload();
            }
        };
    }
</script>
{{end}}