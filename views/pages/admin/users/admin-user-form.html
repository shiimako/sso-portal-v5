{{define "content"}}
<div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-md border border-gray-100">

    <div class="mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <i data-lucide="{{if .Data.IsEdit}}user-cog{{else}}user-plus{{end}}" class="w-6 h-6 text-blue-600"></i>
            {{if .Data.IsEdit}}Edit Pengguna{{else}}Tambah Pengguna Baru{{end}}
        </h2>
        <p class="text-gray-500 text-sm mt-1">Kelola data pengguna, peran, dan jabatan struktural.</p>
    </div>

    <form action="{{if .Data.IsEdit}}/admin/user/update/{{.Data.User.ID}}{{else}}/admin/user/create{{end}}" method="POST" class="space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap <span class="text-red-500">*</span></label>
                <input type="text" name="name" value="{{if .Data.User}}{{.Data.User.Name}}{{end}}" required
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email <span class="text-red-500">*</span></label>
                <input type="email" name="email" value="{{if .Data.User}}{{.Data.User.Email}}{{end}}" required
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">No. Telepon</label>
                <input type="text" name="phone" value="{{if .Data.User}}{{if .Data.User.Phone.Valid}}{{.Data.User.Phone.String}}{{end}}{{end}}"
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status Akun</label>
                <select name="status" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="aktif" {{if .Data.User}}{{if eq .Data.User.Status "aktif"}}selected{{end}}{{end}}>Active</option>
                    <option value="nonaktif" {{if .Data.User}}{{if eq .Data.User.Status "nonaktif"}}selected{{end}}{{end}}>Inactive</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                <textarea name="address" rows="2" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">{{if .Data.User}}{{if .Data.User.Address.Valid}}{{.Data.User.Address.String}}{{end}}{{end}}</textarea>
            </div>
        </div>

        <div x-data="userForm()" x-init="initData()" class="pt-4 border-t border-gray-100">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Peran Utama (Role) <span class="text-red-500">*</span></label>
            <select name="role_id" x-model="role" @change="updateRoleName($event)"
                class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white mb-6">
                {{range .Data.Roles}}
                <option value="{{.ID}}" data-name="{{.Name}}">{{.Name}}</option>
                {{end}}
            </select>

            <div x-show="roleName.includes('mahasiswa')" x-transition class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                <h4 class="text-sm font-bold text-blue-800 flex items-center gap-2 mb-3">
                    <i data-lucide="graduation-cap" class="w-4 h-4"></i> Data Mahasiswa
                </h4>
                <div>
                    <label class="block text-xs font-semibold text-blue-700 uppercase mb-1">NIM</label>
                    <input type="text" name="nim" value="{{if .Data.User}}{{if .Data.User.Student}}{{.Data.User.Student.NIM.String}}{{end}}{{end}}"
                        class="w-full p-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none bg-white">
                </div>
            </div>

            <div x-show="roleName.includes('dosen')" x-transition class="bg-orange-50 p-5 rounded-xl border border-orange-100 space-y-6">
                
                <div>
                    <h4 class="text-sm font-bold text-orange-800 flex items-center gap-2 mb-3">
                        <i data-lucide="briefcase" class="w-4 h-4"></i> Info Kepegawaian
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-orange-700 uppercase mb-1">NIP</label>
                            <input type="text" name="nip" value="{{if .Data.User}}{{if .Data.User.Lecturer}}{{.Data.User.Lecturer.NIP.String}}{{end}}{{end}}"
                                class="w-full p-2 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-400 outline-none bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-orange-700 uppercase mb-1">NUPTK</label>
                            <input type="text" name="nuptk" value="{{if .Data.User}}{{if .Data.User.Lecturer}}{{.Data.User.Lecturer.NUPTK.String}}{{end}}{{end}}"
                                class="w-full p-2 border border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-400 outline-none bg-white">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-orange-200 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="text-sm font-bold text-gray-700">Riwayat Jabatan</h5>
                        <button type="button" @click="addPosition()" class="text-xs bg-orange-100 text-orange-700 px-3 py-1.5 rounded-lg hover:bg-orange-200 font-medium transition flex items-center gap-1">
                            <i data-lucide="plus-circle" class="w-3 h-3"></i> Tambah Jabatan
                        </button>
                    </div>

                    <input type="hidden" name="positions_json" :value="JSON.stringify(positions)">

                    <div class="space-y-3">
                        <template x-for="(pos, index) in positions" :key="index">
                            <div class="p-3 border border-gray-200 rounded-lg bg-gray-50 relative group">
                                <button type="button" @click="removePosition(index)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pr-6">
                                    <div>
                                        <label class="text-xs text-gray-500 font-medium">Nama Jabatan</label>
                                        <select x-model.number="pos.position_id" class="w-full p-1.5 text-sm border rounded bg-white mt-1">
                                            <option value="">-- Pilih --</option>
                                            {{range .Data.MasterPositions}}
                                            <option value="{{.ID}}">{{.Name}}</option>
                                            {{end}}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="text-xs text-gray-500 font-medium">Lingkup Unit</label>
                                        <select x-model="pos.scope" class="w-full p-1.5 text-sm border rounded bg-white mt-1">
                                            <option value="none">Umum (Tidak Ada Unit)</option>
                                            <option value="major">Jurusan</option>
                                            <option value="prodi">Program Studi</option>
                                        </select>
                                    </div>

                                    <div x-show="pos.scope == 'major'" class="md:col-span-2">
                                        <label class="text-xs text-gray-500 font-medium">Pilih Jurusan</label>
                                        <select x-model.number="pos.major_id" class="w-full p-1.5 text-sm border rounded bg-white mt-1">
                                            <option value="0">-- Pilih Jurusan --</option>
                                            {{range .Data.MasterMajors}}
                                            <option value="{{.ID}}">{{.Name}}</option>
                                            {{end}}
                                        </select>
                                    </div>

                                    <div x-show="pos.scope == 'prodi'" class="md:col-span-2">
                                        <label class="text-xs text-gray-500 font-medium">Pilih Prodi</label>
                                        <select x-model.number="pos.prodi_id" class="w-full p-1.5 text-sm border rounded bg-white mt-1">
                                            <option value="0">-- Pilih Prodi --</option>
                                            {{range .Data.MasterProdis}}
                                            <option value="{{.ID}}">{{.Name}}</option>
                                            {{end}}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="text-xs text-gray-500 font-medium">Mulai Menjabat</label>
                                        <input type="date" x-model="pos.start_date" class="w-full p-1.5 text-sm border rounded bg-white mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 font-medium">Selesai (Opsional)</label>
                                        <input type="date" x-model="pos.end_date" class="w-full p-1.5 text-sm border rounded bg-white mt-1">
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="positions.length === 0" class="text-center py-4 text-gray-400 text-sm italic border border-dashed border-gray-300 rounded-lg">
                            Belum ada jabatan yang ditambahkan.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex gap-3 pt-6 border-t border-gray-100">
            <a href="/admin/users" class="px-5 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium transition">Batal</a>
            <button type="submit" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md transition flex items-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i>
                Simpan Data
            </button>
        </div>
    </form>
</div>

<script>
    function userForm() {
        return {
            role: '{{if .Data.User}}{{if .Data.User.Roles}}{{(index .Data.User.Roles 0).RoleID}}{{end}}{{else}}1{{end}}', // Default ID 1 (Admin) jika new
            roleName: '', 
            positions: [],

            initData() {
                const select = document.querySelector('select[name="role_id"]');
                if(select) {
                    const selectedOpt = select.querySelector(`option[value="${this.role}"]`);
                    if(selectedOpt) this.roleName = selectedOpt.getAttribute('data-name').toLowerCase();
                    else this.roleName = 'admin';
                }

                const currentPos = `{{.Data.CurrentPositions}}`;
                if(currentPos && currentPos !== "null") {
                    try {
                        this.positions = JSON.parse(currentPos);
                    } catch(e) { console.error("Error parsing positions", e); }
                }
            },

            updateRoleName(e) {
                const opt = e.target.options[e.target.selectedIndex];
                this.roleName = opt.getAttribute('data-name').toLowerCase();
            },

            addPosition() {
                this.positions.push({
                    position_id: '',
                    scope: 'none',
                    major_id: 0,
                    prodi_id: 0,
                    start_date: '',
                    end_date: ''
                });
            },

            removePosition(index) {
                this.positions.splice(index, 1);
            }
        }
    }
</script>
{{end}}