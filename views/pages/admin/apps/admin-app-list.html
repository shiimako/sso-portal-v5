{{define "content"}}

<div x-data="appList()" class="space-y-6">
  <div class="flex justify-between items-center">
    <h3 class="text-xl font-semibold flex items-center gap-2">
      <i data-lucide="app-window" class="w-5 h-5 text-gray-700"></i>
      Manajemen Aplikasi
    </h3>

    <a
      href="/admin/dashboard"
      class="text-gray-600 hover:text-gray-900 text-sm flex items-center gap-2"
    >
      <i data-lucide="arrow-left" class="w-4 h-4"></i>
      Kembali
    </a>
  </div>

  <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
    <div class="flex-1 w-full flex gap-2">
      <div class="relative flex-1">
        <i
          data-lucide="search"
          class="w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"
        ></i>
        <input
          type="text"
          x-model="search"
          @keyup.enter="applySearch()"
          placeholder="Cari nama/slug lalu tekan Enter..."
          class="w-full p-3 pl-10 border rounded-lg shadow-sm"
        />
      </div>

      <button
        @click="applySearch()"
        class="bg-gray-800 text-white px-4 rounded-lg flex items-center gap-2"
      >
        <i data-lucide="search-check" class="w-4 h-4"></i>
        Cari
      </button>
    </div>

    <a
      href="/admin/applications/new"
      class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg shadow flex items-center gap-2"
    >
      <i data-lucide="plus-circle" class="w-4 h-4"></i>
      Aplikasi Baru
    </a>
  </div>

  <div class="overflow-hidden border rounded-xl shadow bg-white">
    <table class="w-full text-sm">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="px-4 py-3 text-left">ID</th>
          <th class="px-4 py-3 text-left">Nama</th>
          <th class="px-4 py-3 text-left">Slug</th>
          <th class="px-4 py-3 text-left">Target URL</th>
          <th class="px-4 py-3 text-left w-48">Aksi</th>
        </tr>
      </thead>

      <tbody class="divide-y">
        {{range .Data.Apps}}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">{{.ID}}</td>
          <td class="px-4 py-3 font-medium">{{.Name}}</td>
          <td class="px-4 py-3">{{.Slug}}</td>
          <td class="px-4 py-3 text-blue-600 truncate max-w-xs">
            <a href="{{.TargetURL}}" target="_blank" class="hover:underline"
              >{{.TargetURL}}</a
            >
          </td>

          <td class="px-4 py-3">
            <div class="flex gap-2">
              <a
                href="/admin/applications/detail/{{.ID}}"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs flex items-center gap-1"
              >
                <i data-lucide="info" class="w-3 h-3"></i>
                Detail
              </a>

              <a
                href="/admin/applications/edit/{{.ID}}"
                class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1"
              >
                <i data-lucide="pencil" class="w-3 h-3"></i>
                Edit
              </a>

              <button
                @click="confirmDelete({{.ID}}, '{{.Name}}')"
                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs flex items-center gap-1"
              >
                <i data-lucide="trash-2" class="w-3 h-3"></i>
                Hapus
              </button>
            </div>
          </td>
        </tr>
        {{else}}
        <tr>
          <td colspan="5" class="p-6 text-center text-gray-500">
            Data aplikasi tidak ditemukan.
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>

  <div
    x-show="modal"
    x-cloak
    x-transition
    class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50"
  >
    <div
      class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full"
      @click.outside="modal=false"
    >
      <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
        <i data-lucide="alert-octagon" class="w-5 h-5 text-red-600"></i>
        Hapus Aplikasi?
      </h2>

      <p class="text-gray-700 mb-4">
        Anda yakin ingin menghapus aplikasi
        <span class="font-semibold" x-text="deleteName"></span>?
      </p>

      <form :action="deleteURL" method="POST" class="text-right">
        <button
          type="button"
          @click="modal=false"
          class="px-4 py-2 border rounded mr-2 hover:bg-gray-100"
        >
          Batal
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded"
        >
          Ya, Hapus
        </button>
      </form>
    </div>
  </div>

  <div class="flex items-center gap-4 mt-4 pb-6">
    <div class="flex items-center gap-2">
      <label class="text-sm">Page:</label>
      <input
        type="number"
        min="1"
        x-model.number="page"
        class="w-20 p-2 border rounded-md"
        @change="updateURL()"
      />
    </div>

    <div class="flex items-center gap-2">
      <label class="text-sm">Limit:</label>
      <input
        type="number"
        min="1"
        x-model.number="limit"
        class="w-20 p-2 border rounded-md"
        @change="resetPageAndUpdate()"
      />
    </div>

    <button
      class="bg-gray-200 px-3 py-1 rounded-md text-sm hover:bg-gray-300 disabled:opacity-50 flex items-center gap-1"
      @click="prevPage"
      :disabled="page <= 1"
    >
      <i data-lucide="chevron-left" class="w-4 h-4"></i>
      Prev
    </button>

    <button
      class="bg-gray-200 px-3 py-1 rounded-md text-sm hover:bg-gray-300 flex items-center gap-1"
      @click="nextPage"
    >
      Next
      <i data-lucide="chevron-right" class="w-4 h-4"></i>
    </button>
  </div>
</div>

<script>
  function appList() {
    return {
      // Ambil query param 'q' dari URL saat load awal
      search: new URLSearchParams(window.location.search).get("q") || "",
      modal: false,
      deleteURL: "",
      deleteName: "",

      // Ambil page/limit dari Go template
      page: Number("{{.Data.Page}}"),
      limit: Number("{{.Data.Limit}}"),

      confirmDelete(id, name) {
        this.deleteURL = `/admin/applications/delete/${id}`;
        this.deleteName = name;
        this.modal = true;
      },

      // Logic Search Server-side
      applySearch() {
        this.page = 1; // Reset ke halaman 1 jika mencari baru
        this.updateURL();
      },

      // Centralized URL Update
      updateURL() {
        const params = new URLSearchParams();
        params.set("page", this.page);
        params.set("limit", this.limit);
        if (this.search) {
          params.set("search", this.search);
        }
        window.location.search = params.toString();
      },

      resetPageAndUpdate() {
        this.page = 1;
        this.updateURL();
      },

      prevPage() {
        if (this.page > 1) {
          this.page--;
          this.updateURL();
        }
      },

      nextPage() {
        this.page++;
        this.updateURL();
      },
    };
  }
</script>
{{end}}
