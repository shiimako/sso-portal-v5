{{define "content"}}
<div x-data="dashboard()" class="min-h-screen bg-slate-50 pb-24 font-sans">
  <div
    class="relative bg-slate-900 pb-24 rounded-b-[3rem] overflow-hidden shadow-2xl"
  >
    <div class="absolute inset-0 opacity-10">
      <svg
        class="h-full w-full"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
      >
        <path d="M0 100 C 20 0 50 0 100 100 Z" fill="white" />
      </svg>
    </div>

    <div class="relative z-10 pt-12 px-6 sm:px-12 max-w-7xl mx-auto">
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6"
      >
        <div>
          <h1
            class="text-3xl sm:text-4xl font-extrabold text-white tracking-tight"
          >
            Portal Aplikasi
          </h1>
          <p class="text-slate-400 mt-2 text-lg">
            Akses seluruh layanan akademik & administrasi dalam satu pintu.
          </p>
        </div>

        {{if eq .ActiveRole "admin"}}
        <a
          href="/admin/dashboard"
          class="group relative flex items-center gap-3 bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/10 text-white px-6 py-3 rounded-full transition-all duration-300 shadow-lg hover:shadow-indigo-500/20"
        >
          <div
            class="p-1 bg-white/20 rounded-full group-hover:scale-110 transition"
          >
            <i data-lucide="shield-alert" class="w-4 h-4"></i>
          </div>
          <span class="font-medium text-sm">Dashboard Admin</span>

          <div
            x-show="unreadErrors > 0"
            style="display: none"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-50"
            x-transition:enter-end="opacity-100 scale-100"
          >
            <span class="absolute -top-1 -right-1 flex h-5 w-5">
              <span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
              ></span>
              <span
                class="relative inline-flex rounded-full h-5 w-5 bg-red-600 border-2 border-slate-900 text-[10px] font-bold text-white items-center justify-center"
                x-text="unreadErrors > 9 ? '9+' : unreadErrors"
              >
              </span>
            </span>
          </div>
        </a>
        {{end}}
      </div>
    </div>
  </div>

  <div class="px-6 max-w-7xl mx-auto relative z-20 -mt-12">
    <div class="relative z-20 flex flex-col md:flex-row items-stretch md:items-center gap-4 mb-8">
      <div
        class="flex-1 bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-100 flex items-center p-2 transition focus-within:ring-2 focus-within:ring-blue-500/20"
      >
        <div class="pl-4 text-slate-400">
          <i data-lucide="search" class="w-5 h-5"></i>
        </div>
        <input
          type="text"
          x-model="search"
          placeholder="Cari aplikasi (misal: Siwali, E-Learning)..."
          class="w-full p-3 bg-transparent border-none focus:ring-0 text-slate-700 placeholder-slate-400 outline-none font-medium"
        />
      </div>

      <button
        onclick="enableNotif()"
        class="flex items-center justify-center gap-2 bg-white hover:bg-blue-50 text-slate-600 hover:text-blue-700 px-6 py-4 md:py-0 rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-100 transition font-medium text-sm group"
      >
        <i data-lucide="bell" class="w-4 h-4 group-hover:animate-swing"></i>
        <span>Aktifkan Notifikasi</span>
      </button>
    </div>

    <div class="relative w-full z-20 mb-8 mt-10 pt-2 backdrop-blur-sm">
        <div class="flex overflow-x-auto gap-3 pb-2 pt-2 -mx-6 px-6 category-scrollbar touch-pan-x ">
            
            {{range .Data.Categories}}
            <button
                @click="loadCategory({{.ID}})"
                :class="{
                    'bg-slate-900 text-white shadow-lg shadow-slate-900/20 ring-2 ring-slate-900 ring-offset-2 scale-[1.02]': activeCat == {{.ID}},
                    'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:border-slate-400 hover:text-slate-900': activeCat != {{.ID}}
                }"
                class="flex-shrink-0 whitespace-nowrap px-6 py-2.5 rounded-full text-sm font-bold transition-all duration-200"
            >
                {{.Name}}
            </button>
            {{end}}

            <div class="w-2 flex-shrink-0"></div>
        </div>
        
        <div class="absolute right-0 top-0 bottom-2 w-12 bg-gradient-to-l from-slate-50 to-transparent pointer-events-none md:hidden"></div>
    </div>

    <div
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"
    >
      <template x-for="app in filteredApps" :key="app.slug">
        <div
          class="group relative bg-white p-6 rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-slate-100 cursor-pointer transition-all duration-300 transform hover:-translate-y-1.5"
          @click="openApp(app.slug)"
        >
          <template x-if="app.notif_messages.length > 0">
            <div class="absolute -top-3 -right-3 z-30 flex h-8 w-8">
              <span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
              ></span>
              <span
                class="relative inline-flex rounded-full h-8 w-8 bg-gradient-to-br from-red-500 to-pink-600 border-4 border-slate-50 text-xs font-bold text-white items-center justify-center shadow-md"
              >
                <span x-text="app.notif_messages.length"></span>
              </span>
            </div>
          </template>

          <div class="flex justify-center mb-5 relative z-10">
            <div
              class="w-20 h-20 rounded-2xl bg-slate-50 flex items-center justify-center p-3 shadow-inner group-hover:scale-110 transition duration-300"
            >
              <img
                :src="app.icon"
                class="w-full h-full object-contain drop-shadow-sm"
              />
            </div>
          </div>

          <div class="text-center">
            <h4
              class="font-bold text-slate-700 text-sm sm:text-base leading-tight group-hover:text-blue-600 transition-colors"
            >
              <span x-text="app.name"></span>
            </h4>
          </div>
        </div>
      </template>
    </div>

    <div
      x-show="filteredApps.length === 0"
      class="text-center py-20 hidden"
      :class="{'block': true}"
    >
      <div class="bg-white inline-flex p-4 rounded-full shadow-sm mb-4">
        <i data-lucide="search-x" class="w-8 h-8 text-slate-300"></i>
      </div>
      <h3 class="text-lg font-semibold text-slate-700">
        Aplikasi tidak ditemukan
      </h3>
      <p class="text-slate-500 text-sm mt-1">
        Coba gunakan kategori atau kata kunci lain.
      </p>
    </div>
  </div>

  <div
    x-show="show"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    x-cloak
  >
    <div
      class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden transform transition-all"
      @click.outside="show=false"
    >
      <div
        class="bg-slate-50/50 p-6 border-b border-slate-100 flex items-start gap-5"
      >
        <img
          :src="selected.icon"
          class="w-20 h-20 rounded-2xl object-contain bg-white shadow-sm border border-slate-100 p-2"
        />
        <div class="flex-1 pt-1">
          <h2
            class="text-2xl font-bold text-slate-800 leading-tight"
            x-text="selected.name"
          ></h2>
          <span
            class="inline-block mt-2 px-2.5 py-0.5 bg-blue-100 text-blue-700 text-xs font-bold rounded-md uppercase tracking-wide"
            x-text="selected.slug"
          ></span>
        </div>
        <button
          @click="show=false"
          class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-2 rounded-full transition"
        >
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="p-6">
        <div class="mb-6">
          <h5
            class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2"
          >
            Deskripsi Aplikasi
          </h5>
          <p
            class="text-slate-600 leading-relaxed text-sm"
            x-text="selected.description || 'Tidak ada deskripsi tersedia.'"
          ></p>
        </div>

        <template
          x-if="selected.notif_messages && selected.notif_messages.length > 0"
        >
          <div
            class="mb-8 bg-amber-50 border border-amber-100 rounded-2xl p-5 relative overflow-hidden"
          >
            <div
              class="absolute -top-4 -right-4 w-16 h-16 bg-amber-100 rounded-full opacity-50 blur-xl"
            ></div>
            <div class="flex items-center gap-2 mb-3 relative z-10">
              <div class="p-1.5 bg-amber-100 rounded-lg text-amber-600">
                <i data-lucide="bell-ring" class="w-4 h-4"></i>
              </div>
              <h5
                class="text-xs font-bold text-amber-800 uppercase tracking-wide"
              >
                Pemberitahuan (<span
                  x-text="selected.notif_messages.length"
                ></span
                >)
              </h5>
            </div>
            <ul
              class="max-h-48 overflow-y-auto custom-scrollbar space-y-2 pr-2 relative z-10"
            >
              <template
                x-for="(msg, index) in selected.notif_messages"
                :key="index"
              >
                <li
                  class="text-sm text-slate-700 flex items-start gap-3 bg-white/60 p-3 rounded-xl border border-amber-100/50 shadow-sm"
                >
                  <span
                    class="mt-1.5 w-2 h-2 rounded-full bg-amber-500 shrink-0 shadow-sm"
                  ></span>
                  <span x-text="msg" class="leading-snug"></span>
                </li>
              </template>
            </ul>
          </div>
        </template>

        <div class="flex gap-3 pt-2">
          <button
            class="flex-1 px-4 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition active:scale-95"
            @click="show=false"
          >
            Batal
          </button>
          <a
            :href="selected.target"
            class="flex-[2] flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition transform active:scale-95"
          >
            <span
              x-text="selected.notif_messages && selected.notif_messages.length > 0 ? 'Buka & Lihat' : 'Buka Aplikasi'"
            ></span>
            <i data-lucide="external-link" class="w-4 h-4"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="fixed bottom-8 right-8 z-40" x-data="{ fab: false }">
    <div
      class="absolute bottom-20 right-0 flex flex-col items-end gap-3 min-w-[200px]"
      x-show="fab"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 translate-y-4"
      x-transition:enter-end="opacity-100 translate-y-0"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 translate-y-0"
      x-transition:leave-end="opacity-0 translate-y-4"
      style="display: none"
    >
      <a
        href="mailto:{{.Data.Admin.Email}}"
        class="group flex items-center gap-3"
      >
        <span
          class="bg-white text-slate-700 px-4 py-2 rounded-xl shadow-lg shadow-slate-200 border border-slate-100 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
          >Email Admin</span
        >
        <div
          class="w-12 h-12 bg-red-500 text-white rounded-full shadow-xl shadow-red-500/30 flex items-center justify-center hover:bg-red-600 transition hover:scale-110"
        >
          <i data-lucide="mail" class="w-5 h-5"></i>
        </div>
      </a>
      <a
        href="https://wa.me/{{.Data.Admin.Phone}}"
        class="group flex items-center gap-3"
      >
        <span
          class="bg-white text-slate-700 px-4 py-2 rounded-xl shadow-lg shadow-slate-200 border border-slate-100 text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap"
          >Chat WhatsApp</span
        >
        <div
          class="w-12 h-12 bg-green-500 text-white rounded-full shadow-xl shadow-green-500/30 flex items-center justify-center hover:bg-green-600 transition hover:scale-110"
        >
          <i data-lucide="message-circle" class="w-5 h-5"></i>
        </div>
      </a>
    </div>
    <button
      @click="fab = !fab"
      @click.outside="fab = false"
      class="w-14 h-14 bg-slate-900 text-white rounded-full shadow-2xl shadow-slate-900/40 flex items-center justify-center hover:bg-black transition transform active:scale-95 border-4 border-slate-50 z-50"
    >
      <i
        data-lucide="plus"
        class="w-7 h-7 transition-transform duration-300"
        :class="fab ? 'rotate-[135deg]' : ''"
      ></i>
    </button>
  </div>

  <script>
    // ==================================================
    // 1. DATA INJECTION (Server -> Client)
    // ==================================================
    const INITIAL_APPS = {{ json .Data.Apps }} || [];
    const INITIAL_NOTIFS = {{ json .Data.Notifs }} || {};
    const INITIAL_UNREAD_ERRORS = {{ .Data.UnreadErrors }}; // Data Awal Error Admin
    const ACTIVE_CAT_ID = {{ .Data.ActiveCatID }};
    const VAPID_PUBLIC_KEY = "{{.Data.VapidPublicKey}}";

    function dashboard() {
      return {
        search: "",
        show: false,
        selected: {},
        activeCat: ACTIVE_CAT_ID,
        apps: {},
        unreadErrors: INITIAL_UNREAD_ERRORS,

        init() {
            this.processAppsData(INITIAL_APPS, INITIAL_NOTIFS);
            this.$nextTick(() => { lucide.createIcons(); });

            setInterval(() => {
                this.refreshData();
            }, 8000);
        },

        async refreshData() {
            try {
                const res = await fetch(`/dashboard?cat_id=` + this.activeCat, {
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                });

                if (!res.ok) return; 
                const data = await res.json();

                if (data.UnreadErrors !== undefined) {
                    this.unreadErrors = data.UnreadErrors;
                }

                this.processAppsData(data.Apps, data.Notifs);

            } catch (e) {
                console.error("Auto-refresh skip:", e);
            }
        },

        // --- Helpers ---
        processAppsData(appsList, notifsList) {
            let processed = {};
            const list = appsList || [];

            list.forEach(app => {
                let iconPath = "/static/default-app.png";
                if (app.IconURL) {
                    if (typeof app.IconURL === 'object' && app.IconURL.Valid) {
                         iconPath = app.IconURL.String || iconPath;
                    }
                    else if (typeof app.IconURL === 'string' && app.IconURL !== "") {
                        iconPath = app.IconURL;
                    }
                }

                processed[app.Slug] = {
                    name: app.Name,
                    slug: app.Slug,
                    description: app.Description,
                    target: "/redirect?app=" + app.Slug,
                    icon: iconPath,
                    notif_messages: (notifsList && notifsList[app.Slug]) ? notifsList[app.Slug].Messages : []
                };
            });
            this.apps = processed;
        },

        get filteredApps() {
            let result = Object.values(this.apps);
            if (this.search) {
                const q = this.search.toLowerCase();
                result = result.filter(app =>
                    app.slug.toLowerCase().includes(q) ||
                    app.name.toLowerCase().includes(q)
                );
            }
            return result;
        },

        openApp(slug) {
          this.selected = this.apps[slug];
          this.show = true;
        },

        // --- AJAX LOAD CATEGORY ---
        async loadCategory(catID) {
          this.activeCat = catID;

          try {
            const res = await fetch(`/dashboard?cat_id=` + catID, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (!res.ok) throw new Error("Gagal load data");
            const data = await res.json();

            this.processAppsData(data.Apps, data.Notifs);

            if (data.UnreadErrors !== undefined) {
                this.unreadErrors = data.UnreadErrors;
            }

          } catch (e) {
            console.error("Error loading category:", e);
          }
        }
      };
    }

    // ==================================================
    // 2. PUSH NOTIFICATION (VAPID)
    // ==================================================
    function urlB64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function enableNotif() {
      if (!("serviceWorker" in navigator)) return alert("Browser tidak support!");

      const register = await navigator.serviceWorker.register("/sw.js");
      const permission = await Notification.requestPermission();
      if (permission !== "granted") return alert("Izin ditolak!");

      const subscription = await register.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlB64ToUint8Array(VAPID_PUBLIC_KEY),
      });

      await fetch("/api/push/subscribe", {
        method: "POST",
        body: JSON.stringify(subscription),
        headers: { "Content-Type": "application/json" },
      });

      alert("âœ… Notifikasi Aktif!");
    }
  </script>
</div>
{{end}}
